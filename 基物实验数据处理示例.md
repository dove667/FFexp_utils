# 基物实验数据处理包示例

该Notebook展示了基物实验data_utils的各种功能和用法，包括：
- 基本统计分析与直方图
- 线性回归分析
- 误差传递计算
- 数据导出
- 批量数据处理
- 其他实用功能


```python
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
from utils import *

# 设置中文字体
font = set_chinese_font()
```

## 示例1：基本统计分析与直方图

本示例展示如何对一组测量数据进行基本统计分析，计算置信区间，绘制频率分布直方图，并创建统计表格。


```python
# 示例数据 - 某物理量的多次测量结果
data1 = [3.97, 4.06, 4.01, 3.94, 4.00, 4.06, 3.94, 4.03, 3.94, 4.06,
        3.97, 4.09, 4.06, 4.09, 4.06, 3.91, 3.94, 4.06, 4.06, 4.13]
```

### 1.1 计算基本统计量

使用`calculate_statistics`函数计算数据的基本统计量，包括均值、标准差、最大值、最小值等。


```python
# 计算基本统计量
stats = calculate_statistics(data1)
print("基本统计量:")
for key, value in stats.items():
    print(f"{key}: {value}")
```

    基本统计量:
    count: 20
    mean: 4.019
    std: 0.063
    max_value: 4.13
    min_value: 3.91
    median: 4.045
    range_value: 0.22
    

### 1.2 计算置信区间

使用`calculate_confidence_intervals`函数计算不同置信水平下的置信区间。


```python
# 计算置信区间
confidence_intervals = calculate_confidence_intervals(stats['mean'], stats['std'])
print("置信区间:")
for key, value in confidence_intervals.items():
    print(f"{key}: [{value[0]}, {value[1]}], 概率: {value[2]}")
```

    置信区间:
    68.0% 置信区间: [3.956, 4.082], 概率: 0.683
    95.0% 置信区间: [3.896, 4.142], 概率: 0.949
    99.0% 置信区间: [3.857, 4.181], 概率: 0.99
    

### 1.3 计算sigma区间概率

使用`calculate_sigma_probabilities`函数计算数据落在σ、2σ、3σ区间内的理论概率和实际概率。


```python
# 计算sigma区间概率
sigma_probs = calculate_sigma_probabilities(data1, stats['mean'], stats['std'])
print("Sigma区间概率:")
for key, value in sigma_probs.items():
    print(f"{key}: 理论概率: {value[0]}, 实际概率: {value[1]}")
```

    Sigma区间概率:
    1σ: 理论概率: 0.683, 实际概率: 0.6
    2σ: 理论概率: 0.954, 实际概率: 1.0
    3σ: 理论概率: 0.997, 实际概率: 1.0
    

### 1.4 绘制频率分布直方图与正态分布拟合曲线

使用`plot_histogram_with_normal_fit`函数绘制频率分布直方图，并拟合正态分布曲线。

图中黑线是由数据均值和标准差计算得出的正态分布曲线，红线是用核密度估计法计算得出的概率密度曲线。


```python
# 绘制频率分布直方图与正态分布拟合曲线
fig, bins, n = plot_histogram_with_normal_fit(data1, x_label='测量值', 
                                           title='频率分布直方图与正态分布拟合')
plt.savefig('示例1_直方图.png', bbox_inches='tight') # 不裁剪图片
```


    
![png](%E5%9F%BA%E7%89%A9%E5%AE%9E%E9%AA%8C%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E7%A4%BA%E4%BE%8B_files/%E5%9F%BA%E7%89%A9%E5%AE%9E%E9%AA%8C%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E7%A4%BA%E4%BE%8B_11_0.png)
    


### 1.5 创建统计信息表格

使用`create_statistics_table`和`plot_table`函数创建并绘制统计信息表格。


```python
# 创建统计信息表格
stat_table = create_statistics_table(stats)
print("统计信息表格:")

# 绘制统计信息表格
fig_stat, ax_stat = plot_table(stat_table, figsize=(8, 2), 
                             title='基本统计量', save_path='示例1_统计表.png')
```

    统计信息表格:
       数据个数    平均值    标准差    最大值    最小值 中间值（中位数）     范围
    0    20  4.019  0.063  4.130  3.910    4.045  0.220
    


    
![png](%E5%9F%BA%E7%89%A9%E5%AE%9E%E9%AA%8C%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E7%A4%BA%E4%BE%8B_files/%E5%9F%BA%E7%89%A9%E5%AE%9E%E9%AA%8C%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E7%A4%BA%E4%BE%8B_13_1.png)
    


### 1.6 自动划分区间并计算区间统计量

使用`auto_create_intervals`和`calculate_interval_statistics`函数自动划分区间并计算区间统计量。


```python
# 自动划分区间并计算区间统计量
intervals = auto_create_intervals(data1, num_intervals=10)
bin_counts, bin_probs, bin_densities, total_density = calculate_interval_statistics(data1, intervals)

# 创建概率密度表格
density_table = create_density_table(intervals, bin_counts, bin_probs, bin_densities)
print("
概率密度表格:")
print(density_table)

# 绘制概率密度表格
fig_density, ax_density = plot_table(density_table, figsize=(8, 6), 
                                   title='概率密度表', save_path='示例1_密度表.png')
```

## 示例2：线性回归分析

本示例展示如何对一组数据进行线性回归分析，并绘制回归直线。


```python
# 示例数据 - 某物理实验的自变量和因变量
x = np.array([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0])
y = np.array([2.1, 3.9, 6.2, 7.8, 9.9, 12.1, 14.0, 16.2, 17.9, 19.8])

# 进行线性回归分析
reg_results = linear_regression(x, y)
print("线性回归分析结果:")
for key, value in reg_results.items():
    if key != 'prediction':
        print(f"{key}: {value}")

# 使用回归方程进行预测
x_new = 5.5
y_pred = reg_results['prediction'](x_new)
print(f"
当x={x_new}时，预测y值为: {y_pred:.3f}")

# 绘制线性回归图
fig_reg, ax_reg, _ = plot_linear_regression(x, y, x_label='X变量', y_label='Y变量', 
                                         title='线性回归分析', save_path='示例2_线性回归.png')
```

## 示例3：误差传递计算

本示例展示如何使用误差传递公式计算复合函数的误差。


```python
# 示例：计算矩形面积及其误差
# 长度和宽度及其测量误差
length = 5.0  # 单位：cm
width = 3.0   # 单位：cm
length_error = 0.1  # 单位：cm
width_error = 0.05  # 单位：cm

# 定义计算面积的函数
def area_func(l, w):
    "l * w"  # 这里的字符串会被error_propagation函数用作函数表达式
    return l * w

# 计算面积及其误差
area, area_error = error_propagation(area_func, [length, width], [length_error, width_error], ['l', 'w'])

print(f"矩形尺寸: 长 = {length} ± {length_error} cm, 宽 = {width} ± {width_error} cm")
print(f"计算面积: {area} ± {area_error} cm²")
print(f"相对误差: {(area_error/area*100):.2f}%")
```

## 示例4：数据导出

本示例展示如何将数据导出为CSV和Excel文件。


```python
# 创建示例数据
data_dict = {
    '测量值': data1,
    '预测值': [reg_results['prediction'](val) for val in data1],
    '误差': [abs(reg_results['prediction'](val) - val) for val in data1]
}

# 导出为CSV文件
export_success = export_data(data_dict, '示例4_数据导出.csv')
print(f"CSV导出{'成功' if export_success else '失败'}")

# 导出为Excel文件
export_success = export_data(data_dict, '示例4_数据导出.xlsx', format='excel')
print(f"Excel导出{'成功' if export_success else '失败'}")
```

### 4.1 导出为文本文件

除了CSV和Excel格式外，还可以将数据导出为文本文件。


```python
# 导出为文本文件
export_success = export_data(data_dict, '示例4_数据导出.txt', format='txt')
print(f"文本文件导出{'成功' if export_success else '失败'}")
```

## 示例5：批量数据处理

本示例展示如何对多组数据进行批量处理。


```python
# 创建多组数据
data_groups = [
    np.random.normal(10, 1, 50),  # 均值10，标准差1的正态分布
    np.random.normal(15, 2, 50),  # 均值15，标准差2的正态分布
    np.random.normal(20, 1.5, 50)  # 均值20，标准差1.5的正态分布
]

# 批量计算统计量
stats_results = batch_process(data_groups, calculate_statistics)

# 显示结果
for i, stats in enumerate(stats_results):
    print(f"
数据组 {i+1} 的统计结果:")
    for key, value in stats.items():
        print(f"{key}: {value}")
```

### 5.1 批量绘制直方图

使用`batch_process`函数批量绘制多组数据的直方图。


```python
# 定义一个简化的直方图绘制函数
def plot_hist_simple(data, title_suffix=''):
    stats = calculate_statistics(data)
    mean, std = stats['mean'], stats['std']
    title = f'直方图 {title_suffix} (μ={mean:.2f}, σ={std:.2f})'
    fig, _, _ = plot_histogram_with_normal_fit(data, title=title)
    return fig

# 批量绘制直方图
hist_figs = batch_process(data_groups, plot_hist_simple, title_suffix='批量处理')

# 显示第一个图形作为示例
plt.figure(hist_figs[0].number)
plt.show()
```

## 示例6：原始数据表生成

本示例展示如何生成原始数据表，类似于`原始数据表生成.py`中的功能。


```python
# 更多测量数据
more_data = [3.97, 4.06, 4.01, 3.94, 4.00, 4.06, 3.94, 4.03, 3.94, 4.06,
        3.97, 4.09, 4.06, 4.09, 4.06, 3.91, 3.94, 4.06, 4.06, 4.13,
        4.00, 4.00, 4.06, 3.97, 4.03, 4.06, 3.94, 4.06, 4.00, 4.06,
        4.03, 4.06, 4.03, 4.02, 4.00, 4.18, 4.00, 3.97, 4.03, 4.12]

# 将数据转换为 Pandas DataFrame，重新组织成4行10列的表格
df = pd.DataFrame(more_data).T.values.reshape(4, 10)
df = pd.DataFrame(df).applymap(lambda x: f"{x:.3f}" if isinstance(x, float) else x)

# 绘制原始数据表
fig, ax = plt.subplots(figsize=(8, 4))  # 根据数据量调整图片高度
ax.axis('off')  # 不显示坐标轴
ax.table(cellText=df.values, cellLoc='center', loc='center')  # 绘制表格
plt.title('原始数据表', fontproperties=font)
plt.savefig('原始数据表.png', bbox_inches='tight')  # 保存原始数据表为图片
plt.show()  # 显示原始数据表
```

## 示例7：更复杂的误差传递计算

本示例展示如何计算更复杂的误差传递问题。


```python
# 圆柱体的半径、高度及其测量误差
radius = 2.5  # 单位：cm
height = 10.0  # 单位：cm
radius_error = 0.05  # 单位：cm
height_error = 0.1  # 单位：cm

# 定义计算圆柱体体积的函数
def cylinder_volume(r, h):
    "3.14159 * r**2 * h"  # 这里的字符串会被error_propagation函数用作函数表达式
    return np.pi * r**2 * h

# 计算体积及其误差
volume, volume_error = error_propagation(cylinder_volume, [radius, height], [radius_error, height_error], ['r', 'h'])

print(f"圆柱体尺寸: 半径 = {radius} ± {radius_error} cm, 高度 = {height} ± {height_error} cm")
print(f"计算体积: {volume} ± {volume_error} cm³")
print(f"相对误差: {(volume_error/volume*100):.2f}%")
```

## 示例8：自定义区间宽度

本示例展示如何使用自定义区间宽度进行数据分析。


```python
# 使用指定的区间宽度划分区间
intervals_custom = auto_create_intervals(data1, interval_width=0.05)
bin_counts_custom, bin_probs_custom, bin_densities_custom, total_density_custom = calculate_interval_statistics(data1, intervals_custom)

# 创建概率密度表格
density_table_custom = create_density_table(intervals_custom, bin_counts_custom, bin_probs_custom, bin_densities_custom)
print("自定义区间宽度的概率密度表格:")
print(density_table_custom)

# 绘制概率密度表格
fig_density_custom, ax_density_custom = plot_table(density_table_custom, figsize=(8, 8), 
                                               title='自定义区间宽度的概率密度表')
```

## 总结

本Notebook展示了基物实验数据处理包的各种功能，包括：
1. 基本统计分析与直方图
2. 线性回归分析
3. 误差传递计算
4. 数据导出
5. 批量数据处理
6. 原始数据表生成
7. 更复杂的误差传递计算
8. 自定义区间宽度分析

这些功能可以帮助物理实验数据的处理和分析，提高实验报告的质量和效率。
